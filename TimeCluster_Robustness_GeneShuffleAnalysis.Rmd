---
title: "TimeCluster_Robustness_GeneShuffleAnalysis"
author: "Becca"
date: "March 6, 2017"
output: html_document
---
## R Markdown
hese analyses are intended to test the robustness of the hourglass effect in gene expression rank correlations. This is an approach that is complementary to (Hourglass_kmeansRankCor_robustness.rmd). Here, I will shuffle expression values associated with genes across stages. Then computes the Rank Cor between

"sp".shared.OGG.exp - mean by OGG data generated by Pranav or Paul


SpeciesClustmeanWI is from MeanBYCluster_OGG.Rmd. Uses (gene expression data- e.g. Mus.shared.OGG.exp[-c(2:4),] randomized here, cluster id, and k) PWstageCor -- in AllPWcor.Rmd

Mus and Danio stages are culled Mus.shared.OGG.exp[-c(2:4),] & Dan.shared.OGG.exp[-c(1, 12:15),]

```{r, rank correlation for species pair when stage cluster ID is randomized}
 #clusterID
#k= 3 #the number of clusters (k from kmeans)
#x= Danio_clusterID #cluster kmeans id file of species 1
#y = Mus_clusterID #cluster kmeans id file of species 2
#x1 = Dan.shared.OGG.exp[-c(1, 12:15),] #expression data file species 1
#y1 = Mus.shared.OGG.exp[-c(2:4),] #expression data file species 2
#sp1="Dan"
#sp2="Mus"


library("dplyr")
library("plyr")
randomizeGENEexpWIstage<- function (x,y,x1, y1, k, sp1, sp2) {
  x1<- t(apply(x1, 1, sample)) #sample without replacement from each row (OGG) to shuffle gene expression, it also transposes the df for some 
  y1<-t(apply(y1, 1, sample))
  xk<-SpeciesClustmeanWI(x1,x,k)
  yk<-SpeciesClustmeanWI(y1,y,k)
    clustcor<-diag(PWstageCor(xk, yk))
  clustcor=t(data.frame(clustcor))
  clustnum=as.character(1:k)
  sps=c(sp1, sp2)
  sps=paste(sps, collapse = "")
  names=paste(sps, clustnum, sep="_")
    colnames(clustcor)<-names
    row.names(clustcor)<-NULL
  return(clustcor)
}
```

Replicate gene randomization -- this takes forever
========================================

```{r, generate randomized stage by k cluster}
library("dplyr")
library("plyr")
#repT=10 #number of times to replicate randomization
#k=4 #how many k cluster in kmeans 
AllspRandGeneClust<-function(k, repT) {
  cbind.data.frame(do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Mus_clusterID,
                                   Gallus_clusterID,
                                   Mus.shared.OGG.exp[-c(2:4),],
                                   Gal.shared.OGG.exp, 
                                   k, "Mus", "Gal"), 
                      simplify=FALSE ) ), 
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Mus_clusterID,
                                   Xlaev_clusterID,
                                   Mus.shared.OGG.exp[-c(2:4),],
                                   Xlaev.shared.OGG.exp, 
                                   k, "Mus", "Xlaev"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Mus_clusterID,
                                   Xtrop_clusterID,
                                   Mus.shared.OGG.exp[-c(2:4),],
                                   Xtrop.shared.OGG.exp, 
                                   k, "Mus", "Xtrop"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Mus_clusterID, 
                                   Danio_clusterID,
                                   Mus.shared.OGG.exp[-c(2:4),],
                                   Dan.shared.OGG.exp[-c(1, 12:15),], 
                                    k, "Mus", "Dan"), 
                      simplify=FALSE ) ), 
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Gallus_clusterID,
                                   Xlaev_clusterID,
                                   Gal.shared.OGG.exp,
                                   Xlaev.shared.OGG.exp, 
                                   k, "Gal", "Xlaev"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Gallus_clusterID,
                                   Xtrop_clusterID,
                                   Gal.shared.OGG.exp,
                                   Xtrop.shared.OGG.exp, 
                                   k, "Gal", "Xtrop"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Gallus_clusterID, 
                                   Danio_clusterID,
                                   Gal.shared.OGG.exp,
                                   Dan.shared.OGG.exp[-c(1, 12:15),], 
                                    k, "Gal", "Dan"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Xlaev_clusterID,
                                   Xtrop_clusterID,
                                   Xlaev.shared.OGG.exp,
                                   Xtrop.shared.OGG.exp, 
                                   k, "Xlaev", "Xtrop"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Xlaev_clusterID, 
                                   Danio_clusterID,
                                   Xlaev.shared.OGG.exp,
                                   Dan.shared.OGG.exp[-c(1, 12:15),], 
                                    k, "Xlaev", "Dan"), 
                      simplify=FALSE ) ),
                    do.call(rbind, replicate(repT, 
                      randomizeGENEexpWIstage(Xtrop_clusterID, 
                                   Danio_clusterID,
                                   Xtrop.shared.OGG.exp,
                                   Dan.shared.OGG.exp[-c(1, 12:15),], 
                                    k, "Xtrop", "Dan"), 
                      simplify=FALSE ) )
  )}
```
implement
```{r}
Clust4randGene100<-AllspRandGeneClust(4,100)
Clust5randGene100<-AllspRandGeneClust(5,100)
```

select, summarize, and join randomized correlation data for each k number

the function(s) Summary_4ClustRand, Summary_SP4ClustRand, Summary_5ClustRand, and Summary_SP5ClustRand are from 
\All_projects\Phylotypic Stage\R\PhylotypicStage\Hourglass_kmeansRankCor_robustness.RMD

```{r, implement cluster number specific randomization correlation summary}
K4randGene_summary<-Summary_4ClustRand(Clust4randGene100)
K4SPvarGene_summary<-Summary_SP4ClustRand(Clust4randGene100)

K5randGene_summary<-Summary_5ClustRand(Clust5randGene100)  
K5SPvarGene_summary<-Summary_SP5ClustRand(Clust5randGene100)


```
Ploting the randomized and real vs. randomized data
box_RankCor_clust(x) plot function comes from MeanByCluster_OGG.Rmd hereL\All_projects\Phylotypic Stage\R\PhylotypicStage\

The box_RankCor_RandxRealclust if from: \All_projects\Phylotypic Stage\R\PhylotypicStage\Hourglass_kmeansRankCor_robustness.RMD

```{r, ploting real and random rank correlations}
box_RankCor_clust(K4randGene_summary)
box_RankCor_clust(K5randGene_summary)

#compared to real data without xlaev vs xtrop
box_RankCor_clust(AllClustCor4[-10,])
box_RankCor_clust(AllClustCor5[-10,])

#compared to real data without xlaev vs xtrop
box_RankCor_clust(AllClustCor4)
box_RankCor_clust(AllClustCor5)

pdf("RandGENEVSRealRankCor.pdf", useDingbats = FALSE)
box_RankCor_RandxRealclust(K4randGene_summary, AllClustCor4)
#box_RankCor_RandxRealclust(K4randGene_summary[-10,], AllClustCor4[-10,])
box_RankCor_RandxRealclust(K5randGene_summary, AllClustCor5)
#box_RankCor_RandxRealclust(K5randGene_summary[-10,], AllClustCor5[-10,])
dev.off()

```

The below calls 
box_RankCorbySPpair_RandxRealclust4
box_RankCorbySPpair_RandxRealclust5 
from: \All_projects\Phylotypic Stage\R\PhylotypicStage\Hourglass_kmeansRankCor_robustness.RMD

```{r}
pdf("RandGENEVSRealRankCorbySPpair.pdf", useDingbats = FALSE)
box_RankCorbySPpair_RandxRealclust4(K4SPvarGene_summary, AllClustCor4)
box_RankCorbySPpair_RandxRealclust5(K5SPvarGene_summary, AllClustCor5)
dev.off()
```
